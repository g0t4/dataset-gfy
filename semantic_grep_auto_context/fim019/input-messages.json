{
  "options": [],
  "max_tokens": 4096,
  "messages": [
    {
      "content": "You are completing code from a Neovim plugin.\nAs the user types, the plugin suggests code completions based on their cursor position marked with: <|fim_middle|>\nThe surrounding code is limited to X lines above/below the cursor, so it may not be the full file. Focus on the code near <|fim_middle|>Do NOT explain your decisions. Do NOT return markdown blocks ```\nDo NOT repeat surrounding code (suffix/prefix)\nONLY return valid code at the <|fim_middle|> position\nPAY attention to existing whitespace.\nYOU ARE ONLY INSERTING CODE, DO NOT REPEAT PREFIX/SUFFIX. Think about overlap before finishing your thoughts.\n\nFor example, if you see this in a python file:\ndef adder(a, b):\n    return <|fim_middle|> + b\n\nThe correct completion is:\na\n\nNOT:\na + b\n\nand NOT:\n    return a + b\n\nMake sure to practice the code change before you return a suggestion. Take the cursor line (at least) and type it out with the new code and make sure it is valid, correct code.\n",
      "role": "developer"
    },
    {
      "content": "Here is context that's automatically provided, that MAY be relevant.\nrepo: private-auto-edit-suggests\n\n## General project code rules:\n- Never add comments to the end of a line.\n- NEVER add TODO comments for me.\n\n## General Code Preferences\n\n- When rewriting code, leave unrelated code and unrelated comments as is.\n- When an if statement has an AMBIGUOUS condition, extract a variable to meaningfully name it, for example:\n```lua\nlocal is_blank_line = line:match(\"^%s*$\")\nif is_blank_line then\n    -- ...\nend\n```\n\n\n## Python Code Preferences\n\nNaming\n- Use snake_case for functions and variables.\n- Use PascalCase for classes.\n\nType Hints\n- Use type hints to clear up ambiguity and improve code completion.\n- prefer list[] over List[] to mimimizes imports\n- Avoid docstrings, ABSOLUTELY NO trivial comments.\n\n\n# Semantic Grep matches: 5\n\n## ~/repos/github/g0t4/private-auto-edit-suggests/auto_edit/fcpxml/audio_effects.py:29-47\n\n\n# * 2. add <filter-audio> element per <asset-clip>:\n#      <filter-audio ref=\"r3\" name=\"Noise Gate\" presetID=\"[2]Hard Floor Noise Cut.pst\"/>\n#      <filter-audio ref=\"r3\" name=\"Noise Gate\"/>\n#      <filter-audio ref=\"r3\" name=\"Noise Gate\" presetID=\"[2]Percussion Gate.pst\"/>\n#\n#      advanced:\n#\n#        <filter-audio ref=\"r3\" name=\"Noise Gate\"/>                                                                                               <filter-audio ref=\"r3\" name=\"Noise Gate\">\n#          <data key=\"effectState\">...</data>\n#          <param name=\"Reduction [dB]\" key=\"3\" value=\"-25\" auxValue=\"75\"/>\n#        </filter-audio>\n#\n#        - * <param> to adjust thresholds to my liking!\n#          see options in panel in FCPX (set values and then export XML to figure out options)\n#        - IGNORE effectState IIAC it is UI state for properties picker\n#          I'd never set this for imports\n#          IIUC would only be after manual adjusts in FCPX\n\n\n## ~/repos/github/g0t4/private-auto-edit-suggests/auto_edit/fcpxml/audio_effects.py:20-26\n#    does cut off left_speech's taper but appears to have adjustable params that might make that unimportant\n#    so, at a minimum, I wouldn't have to bother with picking ideal frame cut point for right_speech\n#       might need to for left_speech, but NBD if so... what it is cutting off in taper still sounds fine (no clicks)\n#       it is just truncating trailing sounds, that can be cut and still intelligible\n#\n# * 1. add fcpxml.resource[].effect element for entire project:\n#      <effect id=\"r3\" name=\"Noise Gate\" uid=\"AudioUnit: 0x61756678000000b3454d4147\"/>\n\n\n## ~/repos/github/g0t4/private-auto-edit-suggests/auto_edit/fcpxml/audio_effects.py:48-53\ndef add_noise_gate(clip: ET.Element):\n    elem = ET.SubElement(clip, \"filter-audio\", ref=ID_FOR_NOISE_GATE_RESOURCE_EFFECT, name=\"Noise Gate\")\n    # ?? what happens if I just omit ref=ID ... with right name will it work anyways?\n    #   ? can I skip the resource.effect entirely?\n    # PRN set presetID\n    # elem.set(\"presetID\", preset_id)\n\n## ~/repos/github/g0t4/private-auto-edit-suggests/auto_edit/fcpxml/audio_effects.py:5-24\n\n\n# *** things to try (from online dev docs links)\n# adjust-noiseReduction? https://developer.apple.com/documentation/professional-video-applications/adjust-noisereduction\n#    is this related to noise gates?\n# adjust-loudness? https://developer.apple.com/documentation/professional-video-applications/adjust-loudness\n# adjust-EQ? https://developer.apple.com/documentation/professional-video-applications/adjust-eq\n#   voice_enhance\n\n# *** NOISE GATE EFFECT\nID_FOR_NOISE_GATE_RESOURCE_EFFECT = \"r3\"  # PRN build static table (IIAC I can skip or name however I want, right?)\n\n# ***! TODO INCOROPORATE THIS!!!\n#  this worked to nuke breathing! TODO does it also allow other things through? (i.e. typing)?\n#    does not cut off ramp-up (right_speech after gap!!!)\n#    does cut off left_speech's taper but appears to have adjustable params that might make that unimportant\n#    so, at a minimum, I wouldn't have to bother with picking ideal frame cut point for right_speech\n#       might need to for left_speech, but NBD if so... what it is cutting off in taper still sounds fine (no clicks)\n#       it is just truncating trailing sounds, that can be cut and still intelligible\n#\n\n\n## ~/repos/github/g0t4/private-auto-edit-suggests/auto_edit/fcpxml/audio_effects.py:27-29\ndef add_resource_for_noise_gate(resources: ET.Element):\n    # is AudioUnit a fixed identifier for Noise Gate effect?\n    ET.SubElement(resources, \"effect\", id=ID_FOR_NOISE_GATE_RESOURCE_EFFECT, name=\"Noise Gate\", uid=\"AudioUnit: 0x61756678000000b3454d4147\")\n",
      "role": "user"
    },
    {
      "content": "Please complete <|fim_middle|> in the following code (which has carefully preserved indentation):\nimport os\nimport rich\nimport xml.dom.minidom\nimport xml.etree.ElementTree as ET\nfrom auto_edit.fcpxml.audio_effects import add_noise_gate, adjust_volume\nfrom auto_edit.ranges import ContentRange, SilenceRange\nfrom auto_edit.transcribe import WhisperSegment\nfrom moviepy.editor import VideoFileClip\nfrom pathlib import Path\n\ndef prettify(elem):\n    \"\"\"Return a pretty-printed XML string for the Element.\"\"\"\n    rough_string = ET.tostring(elem, 'utf-8')\n    reparsed = xml.dom.minidom.parseString(rough_string)\n    return reparsed.toprettyxml(indent=\"  \")\n\nclass FcpXml:\n\n    # ! FCPXML DTD: https://developer.apple.com/documentation/professional-video-applications/document-type-definition\n\n    def __init__(self, original: VideoFileClip, fcpbundle_path: Path, project_name: str, output_dir: Path, fcpxml_file: Path):\n        # set early so its available in other places:\n        self.root = ET.Element(\"fcpxml\", version=\"1.10\")  # ? 1.12?\n        self.fcpxml_file = fcpxml_file\n        self.fps = original.fps\n        self.use_lane1 = True\n\n        # *** import-options MUST come FIRST, before resources\n        #   https://developer.apple.com/documentation/professional-video-applications/import-options\n        #      more docs about import location: https://developer.apple.com/documentation/professional-video-applications/sending-data-programmatically-to-final-cut-pro#Specify-a-Library-for-the-FCPXML-File\n        #   (pay attention to warning on import if there is a mismatch and check the DTD - ordering is a common issue and the warning is not clear!)\n        #   IIUC import-options must come first b/c they affect importing resources (i.e. media files)\n        self.import_options = ET.SubElement(self.root, \"import-options\")\n        ET.SubElement(self.import_options, \"option\", key=\"library location\", value=str(fcpbundle_path))\n        # \"copy assets\" to 1 (copy) or 0 (link) => I would prefer to move them here for final storage\n        ET.SubElement(self.import_options, \"option\", key=\"copy assets\", value=\"1\")\n        # \"base url\" is for resolving src ATTR on resource elements # ET.SubElement(self.import_options, \"option\", key=\"base url\", value=\"\")\n        #    FYI relative paths work (w/o base url) if relative to this fcpxml file\n        #    IIAC, \"base url\" lets me use a diff relative base path for resources\n        # \"suppress warnings\" is available, but DO NOT CHANGE IT, I wanna see import failures\n\n        self.resources = ET.SubElement(self.root, \"resources\")\n\n        # library(s) must come after resources\n        #   FYI library's location ATTR doesn't work on imports so I don't have it here (see import-options above)\n        self.library = ET.SubElement(\n            self.root,\n            \"library\",\n        )\n\n        self.event = ET.SubElement(self.library, \"event\", name=\"auto\")\n\n        self.project = ET.SubElement(self.event, \"project\", name=project_name)\n\n        self.format_id = \"r1\"\n        self.sequence = ET.SubElement(self.project, \"sequence\", format=self.format_id)\n        self.spine = ET.SubElement(self.sequence, \"spine\")\n\n        ET.SubElement(\n            self.resources,\n            \"format\",\n            id=self.format_id,\n            name=f\"FFVideoFormat3840x2160p{int(original.fps)}\",\n            # IIRC I can set width/height too and it works? could use source resolution (moviepy video attrs)\n            #         <format id=\"r1\" name=\"FFVideoFormat3840x2160p30\" frameDuration=\"100/3000s\" width=\"3840\" height=\"2160\" colorSpace=\"1-1-1 (Rec. 709)\"/>\n            # currently rec 709 is default it appears\n            # 4k exports beautifully and then let youtube/rumble/etc transcode to 1080p etc...\n            #   plus stills in FCPX come out as 4k resolution if project is 4k (b/c underlying video is 4k, but if project is 1080p then stills are exported as 1080p and not that crisp... 4k is also nice for \"Copy Subject\" in Photos app to make my viseage bigger)\n        )\n\n        self.r2_id = \"r2\"\n        self.r2_video = ET.SubElement(\n            self.resources,\n            \"asset\",\n            id=self.r2_id,\n            format=self.format_id,\n        )\n\n        self.r3_noise_gate = <|fim_middle|> \n\n\n        video_path_relative_to_fcpxml = os.path.relpath(original.filename, output_dir)\n        self.media_rep = ET.SubElement(self.r2_video, \"media-rep\", kind=\"original-media\", src=video_path_relative_to_fcpxml)\n\n    def export_xml(self):\n        with open(self.fcpxml_file, \"w\") as xml_file:\n            pretty_xml = prettify(self.root)\n            xml_file.write(pretty_xml)\n        print(f\"exported: {self.fcpxml_file}\")\n\n    def frames_to_fraction(self, frames):\n        # avoid frames \"5.0\" => s/b \"5\"\n        frames_string = str(frames)\n        if frames_string.endswith(\".0\"):\n            frames_string = frames_string[:-2]\n        return f\"{frames_string}/{int(self.fps)}s\"\n\n    def show_seconds(self, frames):\n        return f\"{round(frames/self.fps, 3)}s\"\n\n    def add_silence(self, silence: SilenceRange, is_first_silence: bool):\n        name = \"\"\n\n        max_silence_frames = round(0.5 * self.fps)\n        if is_first_silence:\n            # TODO this really should happen before generating XML! this has no dependency (AFAICT) on the FCPXML format!\n            # TODO don't I already handle this in silence processing? IF NOT, move this out of here!!!\n            name += \"trim-\"\n            # limit to last 0.5s @ 1x\n            if silence.duration_frames() > max_silence_frames:\n                new_start_frame = round(silence.end_frame - max_silence_frames)\n                silence = SilenceRange(new_start_frame, silence.end_frame)\n\n        if silence.duration_frames() > max_silence_frames:\n            name += \"trim-\"\n            new_end_frame = round(silence.start_frame + max_silence_frames)  # KEEP\n            silence = SilenceRange(silence.start_frame, new_end_frame)  # KEEP\n\n        name += f\"silent{silence.start_frame}-{silence.end_frame} / {self.show_seconds(silence.start_frame)}-{self.show_seconds(silence.end_frame)}\"\n\n        clip = ET.SubElement(\n            self.spine,\n            \"asset-clip\",  # https://developer.apple.com/documentation/professional-video-applications/asset-clip\n            name=name,\n            ref=\"r2\",\n            start=self.frames_to_fraction(silence.start_frame),\n            duration=self.frames_to_fraction(silence.duration_frames()),\n            audioRole=\"dialogue\",\n        )\n\n        if silence.dampen:\n            # fixed -30 for now until I get realistic calculation for dampen_db.. which, for now I'd rather pursue noise gate\n            # adjust_volume(clip, -30) # loud breathing will kinda be heard (barely)\n            # adjust_volume(clip, -96) # or just mute it\n            add_noise_gate(clip)\n\n    def add_content(self, content: ContentRange) -> ET.Element:\n        name = f\"content{content.start_frame}-{content.end_frame} / {self.show_seconds(content.start_frame)}-{self.show_seconds(content.end_frame)}\"\n        content_clip_xml = ET.SubElement(\n            self.spine,\n            \"asset-clip\",\n            name=name,\n            ref=\"r2\",\n            start=self.frames_to_fraction(content.start_frame),  # start time w/in the media asset itself\n            duration=self.frames_to_fraction(content.duration_frames()),\n            audioRole=\"dialogue\",\n            # DO NOT SET offset, that caused timing issues, FCPX computes it from duration of ordered clips\n        )\n\n        for t in content.transcriptions:\n            whisper: WhisperSegment = t\n            self.use_lane1 = not self.use_lane1\n\n            # shift transcription timing to avoid start/end of clip (makes editing a PITA)\n            # fyi NOT handling if this happens on the boundary of a future ContentRange/SilenceRange\n            start_frame = whisper.start_frame + content.start_frame\n            if (whisper.start_frame == 0):\n                start_frame += 1\n            duration_frames = whisper.duration_frames()\n            end_frame = start_frame + duration_frames\n            if end_frame == content.end_frame:",
      "role": "user"
    }
  ],
  "chat_template_kwargs": {
    "reasoning_effort": "low"
  },
  "raw": false,
  "model": "gpt-oss:120b",
  "stream": true,
  "top_p": 1,
  "temperature": 1
}
